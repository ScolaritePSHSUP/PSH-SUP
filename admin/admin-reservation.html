<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP ‚Äì D√©tail r√©servation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/PSH-SUP-ADMIN/style.css?v=2">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header">
  <h1>D√©tail r√©servation</h1>
  <p>Validation</p>
</header>

<div class="back-btn-wrapper">
  <a href="admin-reservations-V2.html" class="btn-secondary">‚¨Ö Retour</a>
</div>

<main class="page">
  <section class="card" id="reservationDetail">
    <p>Chargement‚Ä¶</p>
  </section>
</main>

<footer class="footer">¬© PSH SUP ‚Äì Administration ‚Äì 2026</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {

const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(window.location.search);
const reservationId = params.get("id");

const container = document.getElementById("reservationDetail");

if (!reservationId) {
  container.innerHTML = "<p>R√©servation introuvable.</p>";
  return;
}

/* ========== AUTH ========== */
(async () => {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session || data.session.user.user_metadata.role !== "admin") {
    location.href = "admin-login.html";
    return;
  }
  loadReservation();
})();

async function loadReservation() {
  const { data, error } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .eq("id", reservationId)
    .single();

  if (error || !data) {
    container.innerHTML = "<p>Erreur lors du chargement de la r√©servation.</p>";
    return;
  }

  const status = data.status || "pending";

  container.innerHTML = `
    <strong>Salle ${data.salle_numero}</strong>
    <p>üìÖ Date : ${data.jour}</p>
    <p>‚è∞ Heure : ${data.heure_debut} ‚Üí ${data.heure_fin}</p>
    <p>üë§ Nom : ${data.nom}</p>
    <p>Classe : ${data.classe}</p>
    <p>Email : ${data.email || "-"}</p>
    <p>Motif : ${data.motif || "-"}</p>
    <p>Status : <strong>${status}</strong></p>

    ${
      status === "pending" ? `
        <button id="approveBtn" class="btn-primary">‚úî Valider</button>
        <button id="refuseBtn" class="btn-secondary">‚úñ Refuser</button>
      ` : `
        <p style="color:#6b7280;">Cette r√©servation est d√©j√† trait√©e.</p>
      `
    }
  `;

  if (status === "pending") {
    document.getElementById("approveBtn").addEventListener("click", () => {
      if (confirm("Confirmer la validation de cette r√©servation ?")) {
        updateStatus("approved");
      }
    });

    document.getElementById("refuseBtn").addEventListener("click", () => {
      if (confirm("Confirmer le refus de cette r√©servation ?")) {
        updateStatus("refused");
      }
    });
  }
}

async function updateStatus(newStatus) {
  const { error } = await supabaseClient
    .from("reservations_salles")
    .update({ status: newStatus })
    .eq("id", reservationId);

  if (error) {
    alert("Erreur Supabase : " + error.message);
  } else {
    alert("R√©servation mise √† jour");
    window.location.href = "admin-reservations-V2.html";
  }
}

});
</script>

</body>
</html>
