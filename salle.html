<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP â€“ Salle</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header">
  <h1 id="salleTitle">Salle</h1>
  <p id="salleSubtitle">Planning et rÃ©servation</p>
</header>

<main class="page">

  <section class="card" id="salleInfos">
    <p style="color:#6b7280;">Chargement des informationsâ€¦</p>
  </section>

  <!-- VUE PLANNING -->
  <div class="planning-toolbar">
    <button id="viewWeek" class="btn-secondary active">ğŸ“… Semaine</button>
    <button id="viewDay" class="btn-secondary">ğŸ“† Jour</button>
    <input type="date" id="dayPicker" style="display:none;">
  </div>

  <section class="card">
    <h2>ğŸ“… Planning de la salle</h2>

    <div class="planning-legend">
      <span><span class="legend disponible"></span> Disponible</span>
      <span><span class="legend ferme"></span> Cours / fermÃ©</span>
      <span><span class="legend pending"></span> En attente</span>
      <span><span class="legend reserve"></span> RÃ©servÃ©</span>
    </div>

    <div id="planningGrid" class="planning-grid"></div>
  </section>

  <section class="card">
    <h2>âœï¸ RÃ©server cette salle</h2>

    <form id="reservationForm" class="contact-form">
      <input type="text" id="nom" placeholder="Nom & PrÃ©nom" required>
      <input type="text" id="classe" placeholder="Classe" required>

      <input type="date" id="jour" required>

      <div class="form-row">
        <input type="time" id="heureDebut" required>
        <input type="time" id="heureFin" required>
      </div>

      <input type="email" id="email" placeholder="Adresse mail" required>

      <textarea id="motif" placeholder="Motif de la rÃ©servation" required></textarea>

      <button type="submit" class="btn-primary">ğŸ“© Envoyer la demande</button>
    </form>

    <p id="reservationMessage" class="form-message"></p>
  </section>

</main>

<footer class="footer">
  Â© PSH SUP â€“ Vie du campus â€“ 2026
</footer>

<!-- NAVIGATION BASSE -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-item">
    <span>ğŸ </span><small>Accueil</small>
  </a>
  <a href="actualites.html" class="nav-item">
    <span>ğŸ“°</span><small>Actus</small>
  </a>
  <a href="evenements.html" class="nav-item">
    <span>ğŸ“…</span><small>Events</small>
  </a>
  <a href="salles.html" class="nav-item active">
    <span>ğŸ«</span><small>Salles</small>
  </a>
  <a href="contact-admin.html" class="nav-item">
    <span>ğŸ¢</span><small>Admin</small>
  </a>
</nav>

<!-- âœ… TON JS DOIT ÃŠTRE DANS UN SCRIPT -->
<script>
/* ===============================
   ğŸ” SUPABASE CONFIG
=============================== */
const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


/* ===============================
   ğŸ“Œ SALLE DEPUIS URL
=============================== */
const params = new URLSearchParams(window.location.search);
const salleNumero = params.get("numero");

if (!salleNumero) {
  alert("Salle introuvable");
  window.location.href = "salles.html";
}

document.getElementById("salleTitle").textContent = `Salle ${salleNumero}`;

/* ===============================
   ğŸ§  Ã‰TAT GLOBAL
=============================== */
let currentView = "week"; // week | day
let selectedDay = new Date().getDay() || 7;

let lastContraintes = [];
let lastReservations = [];

/* ===============================
   ğŸ“Œ DÃ©tection mobile
=============================== */

const isMobile = window.innerWidth < 768;

if (isMobile) {
  currentView = "day";
  selectedDay = new Date().getDay() || 7;
}

/* ===============================
   ğŸ“… CONSTANTES
=============================== */
const jours = [
  { id: 1, label: "Lun" },
  { id: 2, label: "Mar" },
  { id: 3, label: "Mer" },
  { id: 4, label: "Jeu" },
  { id: 5, label: "Ven" }
];

const heures = [];
for (let h = 8; h < 20; h++) {
  heures.push(`${String(h).padStart(2, "0")}:00`);
  heures.push(`${String(h).padStart(2, "0")}:30`);
}

/* ===============================
   ğŸ« INFOS SALLE
=============================== */
async function loadSalleInfos() {
  const { data, error } = await supabaseClient
    .from("salles")
    .select("*")
    .eq("numero", salleNumero)
    .single();

  const box = document.getElementById("salleInfos");

  if (error || !data) {
    box.innerHTML = "<p style='color:red;'>Salle introuvable</p>";
    return;
  }

  box.innerHTML = `
    ğŸ“ Campus : <strong>${data.campus}</strong><br>
    ğŸ‘¥ CapacitÃ© : <strong>${data.capacite}</strong>
  `;
}

/* ===============================
   ğŸ“… LOAD PLANNING
=============================== */
async function loadPlanningVisuel() {
  const { data: contraintes } = await supabaseClient
    .from("salles_contraintes")
    .select("*")
    .eq("salle_numero", salleNumero);

  const { data: reservations } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .eq("salle_numero", salleNumero);

  lastContraintes = contraintes || [];
  lastReservations = reservations || [];

  renderPlanning(lastContraintes, lastReservations);
}

/* ===============================
   ğŸ§  TOOLTIP
=============================== */
function getTooltipText(type) {
  return {
    disponible: "Disponible",
    ferme: "Cours / fermÃ©",
    pending: "RÃ©servation en attente",
    reserve: "RÃ©servÃ©"
  }[type] || "";
}

/* ===============================
   ğŸ–¥ï¸ RENDER PLANNING
=============================== */
function renderPlanning(contraintes, reservations) {
  const grid = document.getElementById("planningGrid");
  grid.innerHTML = "";

  document.body.classList.toggle("day-view", currentView === "day");

  /* En-tÃªte */
  grid.innerHTML += `<div></div>`;
  jours.forEach(j => {
    const active = currentView === "day" && j.id === selectedDay;
    grid.innerHTML += `<div class="planning-header ${active ? "day-active" : ""}">${j.label}</div>`;
  });

  heures.forEach(h => {
    grid.innerHTML += `<div class="planning-hour">${h}</div>`;

    jours.forEach(j => {
      let classe = "disponible";
      let reservationInfo = "";

      let isFerme = false;
      let isOuvert = false;

      /* ğŸ”‘ Date rÃ©elle correspondant Ã  la colonne */
      const dateAffichee = (() => {
        const today = new Date();
        const diff = j.id - (today.getDay() || 7);
        const d = new Date(today);
        d.setDate(today.getDate() + diff);
        return d.toISOString().split("T")[0]; // YYYY-MM-DD
      })();

      /* ===============================
         CONTRAINTES (date > semaine)
      =============================== */
      contraintes.forEach(c => {
        const matchHeure =
          h >= c.heure_debut.slice(0, 5) &&
          h < c.heure_fin.slice(0, 5);

        if (!matchHeure) return;

        /* ğŸ”´ PRIORITÃ‰ : contrainte Ã  date prÃ©cise */
        if (c.jour_date && c.jour_date === dateAffichee) {
          if (c.type === "ferme" || c.type === "cours") isFerme = true;
          if (c.type === "ouvert") isOuvert = true;
        }

        /* ğŸŸ  Contrainte hebdomadaire classique */
        if (!c.jour_date && c.jour_semaine === j.id) {
          if (c.type === "ferme" || c.type === "cours") isFerme = true;
          if (c.type === "ouvert") isOuvert = true;
        }
      });

      /* RÃ¨gle finale contraintes */
      if (isOuvert) classe = "disponible";
      else if (isFerme) classe = "ferme";

      /* ===============================
         RÃ‰SERVATIONS
      =============================== */
      reservations.forEach(r => {
        const jour = new Date(r.jour).getDay() || 7;

        if (
          jour === j.id &&
          h >= r.heure_debut.slice(0, 5) &&
          h < r.heure_fin.slice(0, 5)
        ) {
          if (r.status === "approved") {
            classe = "reserve";
            reservationInfo = `${r.nom} (${r.classe})`;
          } else if (r.status === "pending") {
            classe = "pending";
            reservationInfo = "En attente";
          }
        }
      });

      const active = currentView === "day" && j.id === selectedDay;

      grid.innerHTML += `
        <div
          class="planning-cell ${classe} ${active ? "day-active" : ""}"
          data-jour="${j.id}"
          data-heure="${h}"
          title="${reservationInfo || getTooltipText(classe)}"
        >
          ${classe === "reserve" ? `<small>${reservationInfo}</small>` : ""}
        </div>
      `;
    });
  });

  activateCellClicks();
}

/* ===============================
   ğŸ–±ï¸ CLIC CELLULE
=============================== */
function activateCellClicks() {
  document.querySelectorAll(".planning-cell.disponible").forEach(cell => {
    cell.onclick = () => {
      const jour = parseInt(cell.dataset.jour);
      const heure = cell.dataset.heure;

      const today = new Date();
      const diff = jour - (today.getDay() || 7);
      const date = new Date(today);
      date.setDate(today.getDate() + diff);

      document.getElementById("jour").value = date.toISOString().split("T")[0];
      document.getElementById("heureDebut").value = heure;
    };
  });
}

/* ===============================
   ğŸ—“ï¸ BOUTONS VUE (IDS HTML)
=============================== */
const btnWeek = document.getElementById("viewWeek");
const btnDay  = document.getElementById("viewDay");
const picker  = document.getElementById("dayPicker");

btnWeek.onclick = () => {
  currentView = "week";
  picker.style.display = "none";
  btnWeek.classList.add("active");
  btnDay.classList.remove("active");
  renderPlanning(lastContraintes, lastReservations);
};

btnDay.onclick = () => {
  currentView = "day";
  picker.style.display = "inline-block";
  btnDay.classList.add("active");
  btnWeek.classList.remove("active");

  // si vide, on met aujourd'hui
  if (!picker.value) picker.valueAsDate = new Date();
  selectedDay = (new Date(picker.value).getDay() || 7);

  renderPlanning(lastContraintes, lastReservations);
};

picker.onchange = e => {
  const d = new Date(e.target.value);
  selectedDay = d.getDay() || 7;
  currentView = "day";
  renderPlanning(lastContraintes, lastReservations);
};

/* ===============================
   ğŸš€ INIT
=============================== */
loadSalleInfos();
loadPlanningVisuel();

if (isMobile) {
  document.getElementById("viewDay").classList.add("active");
  document.getElementById("viewWeek").classList.remove("active");
  document.getElementById("dayPicker").style.display = "inline-block";
  document.getElementById("dayPicker").valueAsDate = new Date();
}

</script>

</body>
</html>
