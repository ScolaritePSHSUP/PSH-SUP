<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP ‚Äì Salle</title>

  <!-- Responsive -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<!-- HEADER -->
<header class="header">
  <h1 id="salleTitle">Salle</h1>
  <p id="salleSubtitle">Planning et r√©servation</p>
</header>

<!-- CONTENU -->
<main class="page">

  <!-- INFOS SALLE -->
  <section class="card" id="salleInfos">
    <p style="color:#6b7280;">Chargement des informations‚Ä¶</p>
  </section>

  <section class="card">
  <h2>üìÖ Planning de la salle</h2>

  <!-- L√âGENDE -->
  <div class="planning-legend">
    <div class="legend-item">
      <span class="legend-color disponible"></span>
      Disponible
    </div>
    <div class="legend-item">
      <span class="legend-color ferme"></span>
      Ferm√© / cours
    </div>
    <div class="legend-item">
      <span class="legend-color reserve"></span>
      R√©serv√©
    </div>
  </div>

  <div id="planningGrid" class="planning-grid"></div>
</section>


  <!-- R√âSERVATION -->
  <section class="card">
    <h2>‚úçÔ∏è R√©server cette salle</h2>

    <form id="reservationForm" class="contact-form">

      <input type="text" id="nom" placeholder="Nom & Pr√©nom" required>
      <input type="text" id="classe" placeholder="Classe" required>

      <input type="date" id="jour" required>

      <div class="form-row">
        <input type="time" id="heureDebut" required>
        <input type="time" id="heureFin" required>
      </div>

      <input type="email" id="email" placeholder="Adresse mail" required>

      <textarea id="motif" placeholder="Motif de la r√©servation" required></textarea>

      <button type="submit" class="btn-primary">
        üì© Envoyer la demande
      </button>

    </form>

    <p id="reservationMessage" class="form-message"></p>
  </section>

</main>

<!-- FOOTER -->
<footer class="footer">
  ¬© PSH SUP ‚Äì Vie du campus ‚Äì 2026
</footer>

<script>
/* ===============================
   üîê SUPABASE CONFIG
=============================== */
const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ===============================
   üìå SALLE DEPUIS L‚ÄôURL
=============================== */
const params = new URLSearchParams(window.location.search);
const salleNumero = params.get("numero");

if (!salleNumero) {
  alert("Salle introuvable");
  window.location.href = "salles.html";
}

document.getElementById("salleTitle").textContent = `Salle ${salleNumero}`;

/* ===============================
   üè´ INFOS SALLE
=============================== */
async function loadSalleInfos() {
  const { data, error } = await supabaseClient
    .from("salles")
    .select("*")
    .eq("numero", salleNumero)
    .single();

  const container = document.getElementById("salleInfos");

  if (error || !data) {
    container.innerHTML = "<p style='color:red;'>Salle introuvable</p>";
    return;
  }

  container.innerHTML = `
    <p>
      üìç Campus : <strong>${data.campus}</strong><br>
      üë• Capacit√© : <strong>${data.capacite}</strong>
    </p>
    ${data.description ? `<p>${data.description}</p>` : ""}
  `;
}

/* ===============================
   üìÖ PLANNING VISUEL
=============================== */

const jours = [
  { id: 1, label: "Lun" },
  { id: 2, label: "Mar" },
  { id: 3, label: "Mer" },
  { id: 4, label: "Jeu" },
  { id: 5, label: "Ven" }
];

const heures = [];
for (let h = 8; h < 20; h++) {
  heures.push(`${String(h).padStart(2, "0")}:00`);
  heures.push(`${String(h).padStart(2, "0")}:30`);
}

async function loadPlanningVisuel() {
  const { data: contraintes } = await supabaseClient
    .from("salles_contraintes")
    .select("*")
    .eq("salle_numero", salleNumero);

  const { data: reservations } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .eq("salle_numero", salleNumero);

  renderPlanning(contraintes || [], reservations || []);
}

function renderPlanning(contraintes, reservations) {
  const grid = document.getElementById("planningGrid");
  grid.innerHTML = "";

  /* En-t√™te */
  grid.innerHTML += `<div></div>`;
  jours.forEach(j => {
    grid.innerHTML += `<div class="planning-header">${j.label}</div>`;
  });

  heures.forEach(h => {
    grid.innerHTML += `<div class="planning-hour">${h}</div>`;

    jours.forEach(j => {
      // üîí PAR D√âFAUT : FERME (car cours)
      let classe = "ferme";

      /* 1Ô∏è‚É£ Contraintes fixes */
      contraintes.forEach(c => {
        if (
          c.jour_semaine === j.id &&
          h >= c.heure_debut.slice(0, 5) &&
          h < c.heure_fin.slice(0, 5)
        ) {
          if (c.type === "ouvert") classe = "disponible";
          if (c.type === "ferme" || c.type === "cours") classe = "ferme";
        }
      });

      /* 2Ô∏è‚É£ R√©servations (priorit√© max) */
      reservations.forEach(r => {
        const jour = new Date(r.jour).getDay() || 7;
        if (
          jour === j.id &&
          h >= r.heure_debut.slice(0, 5) &&
          h < r.heure_fin.slice(0, 5)
        ) {
          classe = "reserve";
        }
      });

      grid.innerHTML += `
  <div 
    class="planning-cell ${classe}"
    data-jour="${j.id}"
    data-heure="${h}"
    title="${getTooltipText(classe)}"
  ></div>
`;
function getTooltipText(classe) {
  if (classe === "disponible") return "Disponible ‚Äì cliquer pour r√©server";
  if (classe === "reserve") return "D√©j√† r√©serv√©";
  return "Indisponible (cours / ferm√©)";
}

    });
  });
}



/* ===============================
   ‚úçÔ∏è R√âSERVATION
=============================== */
document
  .getElementById("reservationForm")
  .addEventListener("submit", async e => {
    e.preventDefault();

    const { error } = await supabaseClient
      .from("reservations_salles")
      .insert({
        salle_numero: salleNumero,
        nom: nom.value,
        classe: classe.value,
        jour: jour.value,
        heure_debut: heureDebut.value,
        heure_fin: heureFin.value,
        email: email.value,
        motif: motif.value
      });

    const msg = document.getElementById("reservationMessage");

    if (error) {
      msg.textContent = "‚ùå Erreur lors de la r√©servation";
      msg.style.color = "red";
      return;
    }

    msg.textContent = "‚úÖ Demande envoy√©e";
    msg.style.color = "green";
    e.target.reset();
    loadPlanningVisuel();
  });

/* ===============================
   üöÄ INIT
=============================== */
loadSalleInfos();
loadPlanningVisuel();


document.addEventListener("click", e => {
  const cell = e.target.closest(".planning-cell");
  if (!cell) return;

  /* ‚õî Bloqu√© si non disponible */
  if (!cell.classList.contains("disponible")) {
    alert("‚õî Cette salle n'est pas disponible √† ce cr√©neau.");
    return;
  }

  const jourSemaine = parseInt(cell.dataset.jour);
  const heureDebut = cell.dataset.heure;

  /* Calcul date r√©elle (semaine en cours) */
  const today = new Date();
  const diff = jourSemaine - (today.getDay() || 7);
  const targetDate = new Date(today);
  targetDate.setDate(today.getDate() + diff);

  const dateISO = targetDate.toISOString().split("T")[0];

  /* Heure fin = +30 min */
  const [h, m] = heureDebut.split(":").map(Number);
  const heureFin = `${String(h + (m === 30 ? 1 : 0)).padStart(2, "0")}:${m === 30 ? "00" : "30"}`;

  /* Pr√©-remplissage */
  document.getElementById("jour").value = dateISO;
  document.getElementById("heureDebut").value = heureDebut;
  document.getElementById("heureFin").value = heureFin;

  /* Scroll fluide vers formulaire */
  document
    .getElementById("reservationForm")
    .scrollIntoView({ behavior: "smooth" });
});

</script>


</body>
</html>
