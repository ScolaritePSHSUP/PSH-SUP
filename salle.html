<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP ‚Äì Salle</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header">
  <h1 id="salleTitle">Salle</h1>
  <p id="salleSubtitle">Planning et r√©servation</p>
</header>

<main class="page">

  <section class="card" id="salleInfos">
    <p style="color:#6b7280;">Chargement des informations‚Ä¶</p>
  </section>

  <!-- VUE PLANNING -->
  <div class="planning-toolbar">
    <button id="viewWeek" class="btn-secondary active">üìÖ Semaine</button>
    <button id="viewDay" class="btn-secondary">üìÜ Jour</button>
    <input type="date" id="dayPicker" style="display:none;">
  </div>

  <section class="card">
    <h2>üìÖ Planning de la salle</h2>

    <div class="planning-legend">
      <span><span class="legend disponible"></span> Disponible</span>
      <span><span class="legend ferme"></span> Cours / ferm√©</span>
      <span><span class="legend pending"></span> En attente</span>
      <span><span class="legend reserve"></span> R√©serv√©</span>
    </div>

    <div id="planningGrid" class="planning-grid"></div>
  </section>

  <section class="card">
    <h2>‚úçÔ∏è R√©server cette salle</h2>

    <form id="reservationForm" class="contact-form">
      <input type="text" id="nom" placeholder="Nom & Pr√©nom" required>
      <input type="text" id="classe" placeholder="Classe" required>

      <input type="date" id="jour" required>

      <div class="form-row">
        <input type="time" id="heureDebut" required>
        <input type="time" id="heureFin" required>
      </div>

      <input type="email" id="email" placeholder="Adresse mail" required>

      <textarea id="motif" placeholder="Motif de la r√©servation" required></textarea>

      <button type="submit" class="btn-primary">üì© Envoyer la demande</button>
    </form>

    <p id="reservationMessage" class="form-message"></p>
  </section>

</main>

<footer class="footer">
  ¬© PSH SUP ‚Äì Vie du campus ‚Äì 2026
</footer>

<!-- NAVIGATION BASSE -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-item">
    <span>üè†</span><small>Accueil</small>
  </a>
  <a href="actualites.html" class="nav-item">
    <span>üì∞</span><small>Actus</small>
  </a>
  <a href="evenements.html" class="nav-item">
    <span>üìÖ</span><small>Events</small>
  </a>
  <a href="salles.html" class="nav-item active">
    <span>üè´</span><small>Salles</small>
  </a>
  <a href="contact-admin.html" class="nav-item">
    <span>üè¢</span><small>Admin</small>
  </a>
</nav>

<script>
const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(window.location.search);
const salleNumero = params.get("numero");

if (!salleNumero) {
  alert("Salle introuvable");
  window.location.href = "salles.html";
}

document.getElementById("salleTitle").textContent = `Salle ${salleNumero}`;

let lastContraintes = [];
let lastReservations = [];

const jours = [
  { id: 1, label: "Lun" },
  { id: 2, label: "Mar" },
  { id: 3, label: "Mer" },
  { id: 4, label: "Jeu" },
  { id: 5, label: "Ven" }
];

const heures = [];
for (let h = 8; h < 20; h++) {
  heures.push(`${String(h).padStart(2, "0")}:00`);
  heures.push(`${String(h).padStart(2, "0")}:30`);
}

async function loadSalleInfos() {
  const { data } = await supabaseClient
    .from("salles")
    .select("*")
    .eq("numero", salleNumero)
    .single();

  if (!data) return;

  document.getElementById("salleInfos").innerHTML = `
    üìç Campus : <strong>${data.campus}</strong><br>
    üë• Capacit√© : <strong>${data.capacite}</strong>
  `;
}

function renderPlanning() {
  const grid = document.getElementById("planningGrid");
  grid.innerHTML = "";

  grid.innerHTML += "<div></div>";
  jours.forEach(j => {
    grid.innerHTML += `<div class="planning-header">${j.label}</div>`;
  });

  heures.forEach(h => {
    grid.innerHTML += `<div class="planning-hour">${h}</div>`;

    jours.forEach(j => {
      let classe = "disponible";

      lastContraintes.forEach(c => {
        if (
          c.jour_semaine === j.id &&
          h >= c.heure_debut.slice(0,5) &&
          h < c.heure_fin.slice(0,5)
        ) classe = "ferme";
      });

      lastReservations.forEach(r => {
        if (r.status === "refused") return;
        const jr = new Date(r.jour).getDay() || 7;
        if (
          jr === j.id &&
          h >= r.heure_debut.slice(0,5) &&
          h < r.heure_fin.slice(0,5)
        ) {
          classe = r.status === "approved" ? "reserve" : "pending";
        }
      });

      grid.innerHTML += `
        <div class="planning-cell ${classe}"
             data-jour="${j.id}"
             data-heure="${h}"></div>`;
    });
  });

  activateCellClicks();
}

function activateCellClicks() {
  document.querySelectorAll(".planning-cell.disponible").forEach(cell => {
    cell.onclick = () => {
      const jour = parseInt(cell.dataset.jour, 10);
      const heure = cell.dataset.heure;

      const d = new Date();
      d.setDate(d.getDate() + (jour - (d.getDay() || 7)));

      document.getElementById("jour").value = d.toISOString().split("T")[0];
      document.getElementById("heureDebut").value = heure;
    };
  });
}

async function loadPlanningVisuel() {
  const { data: contraintes } = await supabaseClient
    .from("salles_contraintes")
    .select("*")
    .eq("salle_numero", salleNumero);

  const { data: reservations } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .eq("salle_numero", salleNumero);

  lastContraintes = contraintes || [];
  lastReservations = reservations || [];

  renderPlanning();
}

document.getElementById("reservationForm").addEventListener("submit", async e => {
  e.preventDefault();
  const msg = document.getElementById("reservationMessage");

  const nom = document.getElementById("nom").value.trim();
  const classe = document.getElementById("classe").value.trim();
  const jour = document.getElementById("jour").value;
  const heure_debut = document.getElementById("heureDebut").value.slice(0,5);
  const heure_fin = document.getElementById("heureFin").value.slice(0,5);
  const email = document.getElementById("email").value.trim();
  const motif = document.getElementById("motif").value.trim();

  const { error } = await supabaseClient
    .from("reservations_salles")
    .insert([{
      salle_numero: parseInt(salleNumero, 10),
      nom,
      classe,
      jour,
      heure_debut,
      heure_fin,
      email,
      motif,
      status: "pending"
    }]);

  if (error) {
    console.error(error);
    msg.textContent = "‚ùå Erreur lors de la r√©servation";
    msg.style.color = "red";
    return;
  }

  await fetch(
  "https://wqjzgpxcudobdbhtatgw.supabase.co/functions/v1/notify-admin",
  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "x-webhook-secret": "psh-notify-2026"
    },
    body: JSON.stringify({
      salle: salleNumero,
      jour,
      heure_debut,
      heure_fin,
      status: "pending"
    })
  }
);


  msg.textContent = "‚úÖ Demande envoy√©e";
  msg.style.color = "green";
  e.target.reset();
  loadPlanningVisuel();
});

loadSalleInfos();
loadPlanningVisuel();
</script>





</body>
</html>
