<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>PSH SUP â€“ Admin RÃ©servations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/PSH-SUP-ADMIN/style.css?v=2">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="header">
  <h1>RÃ©servations de salles</h1>
  <p>Validation et gestion des demandes</p>
</header>

<div class="back-btn-wrapper">
  <a href="admin.html" class="btn-secondary">â¬… Retour dashboard</a>
</div>


<center style="margin-top:1rem;">
  <button id="enablePush" class="btn-primary">ğŸ”” Activer les notifications</button>
</center>

<main class="page">
  <section class="card">
    <h2>ğŸ“‹ Demandes de rÃ©servation</h2>

    <div class="filters-bar">
      <select id="filterStatus">
        <option value="all">Tous les statuts</option>
        <option value="pending">En attente</option>
        <option value="approved">ValidÃ©e</option>
        <option value="refused">RefusÃ©e</option>
      </select>

      <select id="filterSalle">
        <option value="all">Toutes les salles</option>
      </select>

      <input type="date" id="filterDate" />
      <button id="filterReset" class="btn-secondary">RÃ©initialiser</button>
    </div>

    <div id="reservationsList"></div>
  </section>
</main>

<footer class="footer">Â© PSH SUP â€“ Administration â€“ 2026</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {

const SUPABASE_URL = "https://wqjzgpxcudobdbhtatgw.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_RQyY6vwKpcQdlRVFvDVD-A_YybqqTS_";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= AUTH ================= */
(async () => {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session || data.session.user.user_metadata.role !== "admin") {
    location.href = "admin-login.html";
    return;
  }
  loadReservations();
})();

/* ========== PUSH ========== */
document.getElementById("enablePush").addEventListener("click", async () => {
  const permission = await Notification.requestPermission();
  if (permission !== "granted") return alert("Notifications refusÃ©es");

  const reg = await navigator.serviceWorker.register("/PSH-SUP-ADMIN/sw.js");
  await navigator.serviceWorker.ready;

  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array("BETw8tFdLbKb_40zgjvMfccOJhnZyvZiKUwKOwWa7TfFdY1EyoxWt__uTaST0_voPfOL6b38KFuJrbVyXTSSKNo")
  });

  const json = sub.toJSON();

  await supabaseClient.from("push_subscriptions").upsert({
    audience: "admin",
    endpoint: json.endpoint,
    p256dh: json.keys.p256dh,
    auth: json.keys.auth
  });

  alert("âœ… Notifications activÃ©es");
});

function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const raw = atob(base64);
  return Uint8Array.from([...raw].map(c => c.charCodeAt(0)));
}

/* ========== UI ========== */
const el = id => document.getElementById(id);
let allReservations = [];

/* ===== NORMALISATION STATUT ===== */
function normalizeStatus(r) {
  if (r.status) return r.status;
  const s = (r.statut || "").toLowerCase();
  if (s.includes("valid")) return "approved";
  if (s.includes("refus")) return "refused";
  return "pending";
}

async function loadReservations() {
  const { data } = await supabaseClient
    .from("reservations_salles")
    .select("*")
    .order("created_at", { ascending: false });

  allReservations = (data || []).map(r => ({
    ...r,
    _status: normalizeStatus(r)
  }));

  fillSalleFilter();
  applyFilters();
}

function fillSalleFilter() {
  const select = el("filterSalle");
  const salles = [...new Set(allReservations.map(r => String(r.salle_numero)))];
  select.innerHTML =
    `<option value="all">Toutes</option>` +
    salles.map(s => `<option value="${s}">Salle ${s}</option>`).join("");
}

function applyFilters() {
  let list = [...allReservations];
  const s = el("filterStatus").value;
  const salle = el("filterSalle").value;
  const date = el("filterDate").value;

  if (s !== "all") list = list.filter(r => r._status === s);
  if (salle !== "all") list = list.filter(r => String(r.salle_numero) === salle);
  if (date) list = list.filter(r => r.jour === date);

  render(list);
}

async function updateStatus(id, status) {
  alert("CLICK : " + id + " â†’ " + status);

  const { error } = await supabaseClient
    .from("reservations_salles")
    .update({
      status,
      statut: status === "approved" ? "ValidÃ©e" : "RefusÃ©e"
    })
    .eq("id", id);

  if (error) {
    alert("ERREUR SUPABASE : " + error.message);
  } else {
    alert("UPDATE OK");
  }

  loadReservations();
}


function render(list) {
  const c = el("reservationsList");
  c.innerHTML = "";

  if (!list.length) {
    c.innerHTML = "<p>Aucune rÃ©servation</p>";
    return;
  }

  list.forEach(r => {
    const div = document.createElement("div");
    div.className = "reservation-card";

    div.innerHTML = `
      <strong>Salle ${r.salle_numero}</strong>
      <p>ğŸ“… ${r.jour} â° ${r.heure_debut} â†’ ${r.heure_fin}</p>
      <p>ğŸ‘¤ ${r.nom} (${r.classe})</p>
      <p>Status : <strong>${r._status}</strong></p>

      ${
        r._status === "pending" ? `
          <button class="btn-primary approve-btn" data-id="${r.id}">âœ” Valider</button>
          <button class="btn-secondary refuse-btn" data-id="${r.id}">âœ– Refuser</button>
        ` : ""
      }
    `;

    c.appendChild(div);
  });

  document.querySelectorAll(".approve-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      updateStatus(btn.dataset.id, "approved");
    });
  });

  document.querySelectorAll(".refuse-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      updateStatus(btn.dataset.id, "refused");
    });
  });
}

/* ========== FILTRES ========== */
el("filterStatus").addEventListener("change", applyFilters);
el("filterSalle").addEventListener("change", applyFilters);
el("filterDate").addEventListener("change", applyFilters);
el("filterReset").addEventListener("click", () => {
  el("filterStatus").value = "all";
  el("filterSalle").value = "all";
  el("filterDate").value = "";
  applyFilters();
});

});
</script>



</body>
</html>
